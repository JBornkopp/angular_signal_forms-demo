<app-page-header
  title="Reactive Form Watchlist"
  [hasChanges]="hasChanges()"
  (addEntry)="onAddEntry()"
  (save)="onSave()"
/>
<form>
  <div ngAccordionGroup class="basic-accordion" [multiExpandable]="false">
    @for (entry of movieForm().controls; track entry; let index = $index) {
      <div ngAccordionTrigger [panelId]="`form-entry-${index}`" #trigger="ngAccordionTrigger"
           [expanded]="index === autoExpandedFormEntry()">
        <app-accordion-title [isExpanded]="trigger.expanded()">
          <div class="entry-header">
            <div class="title-container">
              <span class="entry-title">{{ entry.controls.title.getRawValue() }}</span>
              <span class="entry-title"> - Watched: </span>
              @if (entry.controls.watched.getRawValue()) {
                <mat-icon fontIcon="check" class="watched-icon" />
              } @else {
                <mat-icon fontIcon="close" class="not-watched-icon" />
              }
            </div>
            <mat-icon
              class="delete-icon"
              fontIcon="delete"
              (click)="onDelete(index, entry.controls.title.getRawValue())"
              (keydown.enter)="onDelete(index, entry.controls.title.getRawValue())"
            />
          </div>
        </app-accordion-title>
      </div>
      <div ngAccordionPanel [panelId]="`form-entry-${index}`">
        <ng-template ngAccordionContent>
          <div class="movie-entry">
            <div class="movie-form">
              <mat-form-field>
                <mat-label>Title</mat-label>
                <input
                  matInput
                  placeholder="Add the title of the movie"
                  [formControl]="entry.controls.title"
                >
                @if (entry.controls.title.hasError('required') && entry.controls.title.touched && entry.controls.title.dirty) {
                  <mat-error>The title is required!</mat-error>
                }
              </mat-form-field>

              <div class="form-entry select-box-container">
                <mat-label class="select-box-label">Genre *</mat-label>
                <div class="select-box-content">
                  <app-reactive-select-box
                  [entries]="movieGenreValues"
                  [formControl]="entry.controls.genre"
                  />
                  @if (entry.controls.genre.hasError('required') && entry.controls.genre.touched && entry.controls.genre.dirty) {
                    <mat-error>The genre is required!</mat-error>
                  }
                </div>
              </div>

              <div class="form-entry select-box-container">
                <mat-label class="select-box-label">Where to watch *</mat-label>
                <div class="select-box-content">
                  <app-reactive-select-box
                    [entries]="streamingServiceValues"
                    [formControl]="entry.controls.streamingService"
                  />
                  @if (entry.controls.streamingService.hasError('required') && entry.controls.streamingService.touched && entry.controls.streamingService.dirty) {
                    <mat-error>The streaming service is required!</mat-error>
                  }
                </div>
              </div>

              <mat-form-field>
                <mat-label>Runtime</mat-label>
                <input
                  matInput
                  type="number"
                  placeholder="Add the runtime of the movie"
                  [formControl]="entry.controls.runtime"
                >
                <mat-hint>In minutes</mat-hint>
                @if (entry.controls.runtime.hasError('min') && entry.controls.runtime.touched && entry.controls.runtime.dirty) {
                  <mat-error>Runtime must be at least 1 minute</mat-error>
                }
              </mat-form-field>

              <div class="form-entry select-box-container">
                <mat-label class="select-box-label">Priority *</mat-label>
                <div class="select-box-content">
                  <app-reactive-select-box
                    [entries]="priorityLevelValues"
                    [formControl]="entry.controls.priority"
                  ></app-reactive-select-box>
                  @if (entry.controls.priority.hasError('required') && entry.controls.priority.touched && entry.controls.priority.dirty) {
                    <mat-error>The priority is required!</mat-error>
                  }
                </div>
              </div>

              <div class="form-entry watched-container">
                <div class="content">
                  <mat-checkbox [formControl]="entry.controls.watched">Watched</mat-checkbox>
                </div>
                <div class="error"></div>
              </div>

              <div class="form-entry rating-container">
                <div class="content">
                  <mat-label>Rating</mat-label>
                  <app-reactive-form-rating [formControl]="entry.controls.rating" />
                </div>
                <div class="error">
                  @if (entry.controls.rating.hasError('rating-applied-but-not-watched') && entry.controls.rating.touched && entry.controls.rating.dirty) {
                    <mat-error>The rating can only be applied when the movie was watched!</mat-error>
                  }
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </div>
    } @empty {
      <div ngAccordionTrigger panelId="empty" #triggerEmpty="ngAccordionTrigger"
           [expanded]="true">
        <app-accordion-title [isExpanded]="triggerEmpty.expanded()">
          No entry.
        </app-accordion-title>
      </div>
      <div ngAccordionPanel panelId="empty">
        <ng-template ngAccordionContent>
          <div class="movie-entry">
            There are no entries in your watchlist!
          </div>
        </ng-template>
      </div>
    }
  </div>
</form>
